<?xml version="1.0" encoding="UTF-8"?>
<b:beans xmlns:b="http://www.springframework.org/schema/beans"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://www.springframework.org/schema/security"
         xsi:schemaLocation="
        http://www.springframework.org/schema/security
        http://www.springframework.org/schema/security/spring-security.xsd
        http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd">

    <b:bean id="dataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
        <b:property name="driverClassName" value="com.mysql.jdbc.Driver"/>
        <b:property name="url"
                    value="jdbc:mysql://localhost:3306/StaffJobs?verifyServerCertificate=false&amp;allowPublicKeyRetrieval=true&amp;useSSL=false&amp;requireSSL=false&amp;useLegacyDatetimeCode=false&amp;serverTimezone=UTC"/>
        <b:property name="username" value="root"/>
        <b:property name="password" value="root"/>
    </b:bean>

    <b:bean id="sessionFactory" class="org.springframework.orm.hibernate5.LocalSessionFactoryBean">
        <b:property name="dataSource" ref="dataSource"/>
        <b:property name="hibernateProperties">
            <b:props>
                <b:prop key="hibernate.dialect">org.hibernate.dialect.MySQL5Dialect</b:prop>
                <b:prop key="hibernate.hbm2ddl.auto">update</b:prop>
                <b:prop key="hibernate.show_sql">true</b:prop>
                <b:prop key="hibernate.format_sql">true</b:prop>
            </b:props>
        </b:property>
    </b:bean>

    <b:bean id="passwordEncoder" class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder">
        <b:constructor-arg name="strength" value="11"/>
    </b:bean>

    <b:bean id="jwtLoginFilter" class="dev.java.security.JWTLoginFilter">
        <b:constructor-arg index="0" type="java.lang.String" value="/login"/>
        <b:constructor-arg index="1" type="org.springframework.security.authentication.AuthenticationManager" ref="authenticationManager" />
    </b:bean>

    <b:bean id="jwtAuthenticationFilter" class="dev.java.security.JWTAuthenticationFilter"/>


    <http auto-config="true"> <!-- Это сокращенный синтаксис, отвечает за установку логина на основе веб-формы, базовый логин и выход из приложения -->
        <csrf disabled="true"/>
        <intercept-url pattern="/login"
                       access="permitAll()" method="POST"/> <!-- Задает шаблон, с которым сравниваются URL-адреа входящих запросов, тоесть что бы попасть в любой файл(так как у нас в pattern="/") нам нужно иметь доступ админа -->
        <intercept-url pattern="/candidates" access="hasAuthority('ADMIN')"/>
        <custom-filter before="FORM_LOGIN_FILTER" ref="jwtLoginFilter"/>
        <custom-filter after="FORM_LOGIN_FILTER" ref="jwtAuthenticationFilter"/>
    </http>

    <authentication-manager id="authenticationManager">
        <authentication-provider>
            <jdbc-user-service
                    data-source-ref="dataSource"
                    authorities-by-username-query=
                            "select email, role.name from user, role join user_roles on role.id = user_roles.role_id where email=?"
                    users-by-username-query="SELECT email, password, state FROM user WHERE email=?"
            />
            <password-encoder ref="passwordEncoder"/>
        </authentication-provider>
    </authentication-manager>
    <b:bean id="userDetailsManager" class="org.springframework.security.provisioning.JdbcUserDetailsManager">
        <b:property name="dataSource" ref="dataSource"/>
    </b:bean>
</b:beans>